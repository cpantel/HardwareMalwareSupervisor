var colors = require('colors');

class Monitor {
  constructor(cpu, ram, troyan) {
    this.outputEnabled = true;
    this.cpu = cpu;
    this.ram = ram;
    this.troyan = troyan;
  }
}

Monitor.prototype.format = function(n) {
   return n < 16 ? "0" + n.toString(16) : n.toString(16);
}

Monitor.prototype.displayLed = function(n) {
  return n ?  "X" :  ".";
}

Monitor.prototype.displayLedArray = function(n) {
  var bin = n.toString(2);

  bin = "0".repeat(4-bin.length) + bin;
  return bin.split("").map(
    function(d){
      return d == "0" ? "." : "X";
    }
  ).join("");
}

Monitor.prototype.show = function() {
    if (this.cpu.lastPC == 0x10) {
       console.log("======== harmless nops ========".green);
    }
    if (this.cpu.lastPC == 0x16) {
       console.log("======== legal out ========".green);
    }
    if (this.cpu.lastPC == 0x1C) {
       console.log("======== failed out ========".red);
    }
    if (this.cpu.lastPC == 0x22) {
      console.log("======== attack start ========".cyan);
      this.outputEnabled = false;
    }
    if (this.cpu.lastPC == 0x26) {
      console.log("======== attack end ========".cyan);
      this.outputEnabled = true;
    }
    if (this.cpu.lastPC == 0x27) {
      console.log("======== exploitation ========".brightCyan);
    }
    if (this.outputEnabled || ( (this.cpu.backdoorTrigger + 1 )% 50 == 0 ) ) {
      console.log("PC: ".yellow + this.format(this.cpu.lastPC) +
        " op: ".yellow + this.cpu.opcode.toString(16) +
             "/" + this.cpu.opcodeName +
        " data: ".yellow + this.cpu.data.toString(16) +
        " A: ".yellow + this.format(this.cpu.A) +
        " RA: ".yellow + this.format(this.cpu.RA) +
        "   FLAGS (ZSE): ".yellow + this.displayLed(this.cpu.getZero()) +
                 " " + this.displayLed(this.cpu.supervisor) +
                 " " + this.displayLed(this.cpu.error > 0) +
        " GPIO: ".yellow + this.displayLedArray(this.ram.getGPIO()) +
        "   BDT: ".yellow + this.troyan.backdoorTrigger
      );
    }
}

module.exports = Monitor;
